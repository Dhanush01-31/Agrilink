{% extends 'base.html' %}
{% block content %}

<div class="container-fluid px-lg-5 py-4">

    <!-- HEADER -->
    <div class="row mb-5 align-items-center">
        <div class="col-lg-8">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                    <i class="bi bi-person-badge-fill fs-3 text-success"></i>
                </div>
                <div>
                    <h1 class="fw-bold text-success mb-1">Farmer Dashboard</h1>
                    <p class="text-muted mb-0">Manage your agricultural profile, products, and land requests</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
            <button class="btn btn-success px-4 py-2 fw-semibold rounded-3"
                    data-bs-toggle="modal"
                    data-bs-target="#farmerModal">
                <i class="bi bi-pencil-square me-2"></i>Update Profile
            </button>
        </div>
    </div>

    <!-- STATS CARDS -->
    <div class="row g-4 mb-5">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient-light hover-lift">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-warning bg-opacity-15 p-3 rounded-circle me-3">
                            <i class="bi bi-clock-history text-warning fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0">{{ pending_count }}</h3>
                            <p class="text-muted mb-0">Pending Requests</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient-light hover-lift">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-success bg-opacity-15 p-3 rounded-circle me-3">
                            <i class="bi bi-check-circle-fill text-success fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0">{{ approved_count }}</h3>
                            <p class="text-muted mb-0">Approved</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient-light hover-lift">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-danger bg-opacity-15 p-3 rounded-circle me-3">
                            <i class="bi bi-x-circle-fill text-danger fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0">{{ cancelled_count }}</h3>
                            <p class="text-muted mb-0">Cancelled</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100 bg-gradient-light hover-lift">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center">
                        <div class="bg-info bg-opacity-15 p-3 rounded-circle me-3">
                            <i class="bi bi-basket-fill text-info fs-4"></i>
                        </div>
                        <div>
                            <h3 class="fw-bold mb-0">{{ products.count }}</h3>
                            <p class="text-muted mb-0">My Products</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MY PRODUCTS -->
    <div class="card border-0 shadow-lg mb-5">
        <div class="card-header bg-white border-0 py-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-success mb-1">
                        <i class="bi bi-basket me-2"></i>My Products
                    </h2>
                    <p class="text-muted mb-0">Manage your agricultural products</p>
                </div>
                <button class="btn btn-success px-4 py-2 rounded-3 fw-semibold"
                        data-bs-toggle="modal"
                        data-bs-target="#productModal">
                    <i class="bi bi-plus-lg me-2"></i>Add Product
                </button>
            </div>
        </div>
        <div class="card-body p-4">
            {% if products %}
            <div class="row g-4">
                {% for product in products %}
                <div class="col-xl-3 col-lg-4 col-md-6">
                    <div class="card border-0 shadow-sm h-100 product-card">
                        <div class="position-relative">
                            {% if product.images.first %}
                            <img src="{{ product.images.first.image.url }}"
                                 class="card-img-top product-img"
                                 alt="{{ product.name }}">
                            {% else %}
                            <div class="bg-light product-placeholder d-flex align-items-center justify-content-center">
                                <i class="bi bi-image fs-1 text-muted"></i>
                            </div>
                            {% endif %}
                            <div class="product-badge">
                                <span class="badge bg-success">In Stock: {{ product.quantity }}</span>
                            </div>
                        </div>
                        <div class="card-body p-3">
                            <h5 class="fw-bold text-dark mb-2">{{ product.name }}</h5>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fs-5 fw-bold text-success">â‚¹{{ product.price }}</span>
                                <button class="btn btn-sm btn-outline-success rounded-pill">
                                    <i class="bi bi-eye me-1"></i>View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                    <i class="bi bi-basket fs-1 text-muted"></i>
                </div>
                <h4 class="fw-semibold text-muted mb-2">No Products Yet</h4>
                <p class="text-muted mb-4">Start by adding your first agricultural product</p>
                <button class="btn btn-success px-4 py-2 rounded-3"
                        data-bs-toggle="modal"
                        data-bs-target="#productModal">
                    <i class="bi bi-plus-lg me-2"></i>Add First Product
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- AVAILABLE LANDS -->
    <div class="card border-0 shadow-lg mb-5">
        <div class="card-header bg-white border-0 py-4">
            <h2 class="fw-bold text-success mb-1">
                <i class="bi bi-geo-alt me-2"></i>Available Lands
            </h2>
            <p class="text-muted mb-0">Browse and request available agricultural lands</p>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                {% for land in lands %}
                <div class="col-xl-4 col-lg-6">
                    <div class="card border-0 shadow-sm h-100 land-card">
                        <div class="position-relative">
                            {% if land.images.first %}
                            <img src="{{ land.images.first.image.url }}"
                                 class="card-img-top land-img"
                                 alt="{{ land.farm_name }}">
                            {% else %}
                            <div class="bg-light land-placeholder d-flex align-items-center justify-content-center">
                                <i class="bi bi-image fs-1 text-muted"></i>
                            </div>
                            {% endif %}
                            <div class="land-overlay">
                                <span class="badge bg-success">{{ land.get_soil_type_display }}</span>
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <h5 class="fw-bold text-dark mb-2">{{ land.farm_name }}</h5>
                            <p class="text-muted mb-3">
                                <i class="bi bi-geo-alt me-1"></i>{{ land.location }}
                            </p>
                            <div class="mb-3">
                                <span class="badge bg-info bg-opacity-10 text-info me-2">
                                    {{ land.get_suitable_for_display }}
                                </span>
                            </div>
                            <button class="btn btn-success w-100 py-2 rounded-3 fw-semibold"
                                    onclick="setLand('{{ land.id }}')"
                                    data-bs-toggle="modal"
                                    data-bs-target="#requestModal">
                                <i class="bi bi-send me-2"></i>Send Request
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12 text-center py-5">
                    <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                        <i class="bi bi-tree fs-1 text-muted"></i>
                    </div>
                    <h4 class="fw-semibold text-muted mb-2">No Lands Available</h4>
                    <p class="text-muted">Check back later for available agricultural lands</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- MY REQUESTS -->
    <div class="card border-0 shadow-lg">
        <div class="card-header bg-white border-0 py-4">
            <h2 class="fw-bold text-success mb-1">
                <i class="bi bi-clipboard-check me-2"></i>My Requests
            </h2>
            <p class="text-muted mb-0">Track your land request status</p>
        </div>
        <div class="card-body p-4">
            {% if requests %}
            <div class="row g-3">
                {% for r in requests %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm hover-lift">
                        <div class="card-body p-4">
                            <div class="row align-items-center">
                                <div class="col-lg-8 mb-3 mb-lg-0">
                                    <h5 class="fw-bold text-dark mb-2">{{ r.land.farm_name }}</h5>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-chat-left-text me-1"></i>{{ r.message|truncatechars:100 }}
                                    </p>
                                    <div class="mt-2">
                                        <span class="badge 
                                            {% if r.status == 'approved' %}bg-success
                                            {% elif r.status == 'pending' %}bg-warning
                                            {% else %}bg-danger{% endif %} py-2 px-3">
                                            <i class="bi 
                                                {% if r.status == 'approved' %}bi-check-circle
                                                {% elif r.status == 'pending' %}bi-clock
                                                {% else %}bi-x-circle{% endif %} me-1"></i>
                                            {{ r.status|title }}
                                        </span>
                                        <span class="text-muted ms-3">
                                            <i class="bi bi-calendar me-1"></i>{{ r.created_at|date:"M d, Y" }}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-4 text-lg-end">
                                    {% if r.status == 'pending' %}
                                    <a href="{% url 'cancel_request' r.id %}"
                                       class="btn btn-danger px-4 py-2 rounded-3 fw-semibold">
                                        <i class="bi bi-x-circle me-2"></i>Cancel Request
                                    </a>
                                    {% elif r.status == 'approved' %}
                                    <span class="badge bg-success bg-opacity-10 text-success py-2 px-3">
                                        <i class="bi bi-check-lg me-1"></i>Approved
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                    <i class="bi bi-clipboard fs-1 text-muted"></i>
                </div>
                <h4 class="fw-semibold text-muted mb-2">No Requests Yet</h4>
                <p class="text-muted">Send your first land request to get started</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- ADD PRODUCT MODAL -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header bg-success text-white py-4">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-plus-circle me-2"></i>Add New Product
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Fixed form layout with proper alignment -->
                    <div class="row g-3">
                        {% for field in product_form %}
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold mb-2">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {% if field.field.widget.input_type == 'select' %}
                                    <select name="{{ field.name }}" id="{{ field.id_for_label }}" 
                                            class="form-select {% if field.errors %}is-invalid{% endif %}"
                                            {% if field.field.required %}required{% endif %}>
                                        {% for choice in field.field.choices %}
                                            <option value="{{ choice.0 }}" {% if field.value == choice.0 %}selected{% endif %}>
                                                {{ choice.1 }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% else %}
                                    <input type="{{ field.field.widget.input_type }}" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           value="{{ field.value|default:'' }}"
                                           class="form-control {% if field.errors %}is-invalid{% endif %}"
                                           {% if field.field.required %}required{% endif %}
                                           {% if field.field.widget.attrs.placeholder %}placeholder="{{ field.field.widget.attrs.placeholder }}"{% endif %}>
                                {% endif %}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback">
                                        {{ field.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- File upload section -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group mb-3">
                                <label class="form-label fw-semibold mb-2">
                                    <i class="bi bi-images me-1"></i>Product Images
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="file" name="images" 
                                       class="form-control {% if product_form.errors.images %}is-invalid{% endif %}" 
                                       multiple required
                                       accept="image/*">
                                <div class="form-text">Upload multiple images of your product (JPG, PNG, etc.)</div>
                                {% if product_form.errors.images %}
                                    <div class="invalid-feedback">
                                        {{ product_form.errors.images.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview of selected images -->
                    <div class="row d-none" id="imagePreviewContainer">
                        <div class="col-12">
                            <label class="form-label fw-semibold mb-2">Selected Images</label>
                            <div class="d-flex flex-wrap gap-2" id="imagePreview"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-light px-4 py-2 rounded-3" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" name="add_product" class="btn btn-success px-4 py-2 rounded-3 fw-semibold">
                        <i class="bi bi-save me-2"></i>Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- FARMER PROFILE MODAL -->
<div class="modal fade" id="farmerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <form method="POST">
                {% csrf_token %}
                <div class="modal-header bg-success text-white py-4">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-person-circle me-2"></i>Update Farmer Profile
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row g-3">
                        {% for field in form %}
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label fw-semibold mb-2">
                                    {{ field.label }}
                                    {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                {% if field.field.widget.input_type == 'select' %}
                                    <select name="{{ field.name }}" id="{{ field.id_for_label }}" 
                                            class="form-select {% if field.errors %}is-invalid{% endif %}"
                                            {% if field.field.required %}required{% endif %}>
                                        {% for choice in field.field.choices %}
                                            <option value="{{ choice.0 }}" {% if field.value == choice.0 %}selected{% endif %}>
                                                {{ choice.1 }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                {% elif field.field.widget.input_type == 'textarea' %}
                                    <textarea name="{{ field.name }}" 
                                              id="{{ field.id_for_label }}"
                                              class="form-control {% if field.errors %}is-invalid{% endif %}"
                                              rows="3"
                                              {% if field.field.required %}required{% endif %}>
                                        {{ field.value|default:'' }}
                                    </textarea>
                                {% else %}
                                    <input type="{{ field.field.widget.input_type }}" 
                                           name="{{ field.name }}" 
                                           id="{{ field.id_for_label }}"
                                           value="{{ field.value|default:'' }}"
                                           class="form-control {% if field.errors %}is-invalid{% endif %}"
                                           {% if field.field.required %}required{% endif %}
                                           {% if field.field.widget.attrs.placeholder %}placeholder="{{ field.field.widget.attrs.placeholder }}"{% endif %}>
                                {% endif %}
                                {% if field.help_text %}
                                    <div class="form-text">{{ field.help_text }}</div>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="invalid-feedback">
                                        {{ field.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-light px-4 py-2 rounded-3" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" name="save_farmer" class="btn btn-success px-4 py-2 rounded-3 fw-semibold">
                        <i class="bi bi-check-circle me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SEND REQUEST MODAL -->
<div class="modal fade" id="requestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="land_id" id="land_id">
                <div class="modal-header bg-success text-white py-4">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-send me-2"></i>Send Land Request
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="form-group mb-3">
                        <label for="{{ req_form.message.id_for_label }}" class="form-label fw-semibold mb-2">
                            <i class="bi bi-chat-left-text me-1"></i>Your Message
                            <span class="text-danger">*</span>
                        </label>
                        <textarea name="{{ req_form.message.name }}" 
                                  id="{{ req_form.message.id_for_label }}"
                                  class="form-control {% if req_form.message.errors %}is-invalid{% endif %}"
                                  rows="4"
                                  placeholder="Explain why you're interested in this land and your farming plans..."
                                  required>{{ req_form.message.value|default:'' }}</textarea>
                        <div class="form-text">Describe your farming experience and plans for this land</div>
                        {% if req_form.message.errors %}
                            <div class="invalid-feedback">
                                {{ req_form.message.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer border-0 p-4">
                    <button type="button" class="btn btn-light px-4 py-2 rounded-3" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" name="send_request" class="btn btn-success px-4 py-2 rounded-3 fw-semibold">
                        <i class="bi bi-send me-2"></i>Send Request
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .product-img, .land-img {
        height: 200px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
    }
    
    .product-placeholder, .land-placeholder {
        height: 200px;
        border-radius: 12px 12px 0 0;
    }
    
    .product-card, .land-card {
        transition: transform 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .product-card:hover, .land-card:hover {
        transform: translateY(-5px);
    }
    
    .product-badge {
        position: absolute;
        top: 15px;
        right: 15px;
    }
    
    .land-overlay {
        position: absolute;
        top: 15px;
        left: 15px;
    }
    
    .hover-lift {
        transition: transform 0.2s ease;
    }
    
    .hover-lift:hover {
        transform: translateY(-2px);
    }
    
    .bg-gradient-light {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .form-control, .form-select, textarea.form-control {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 10px 15px;
        font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus, textarea.form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.1);
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    .form-label {
        font-size: 0.9rem;
        color: #495057;
    }
    
    .form-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .invalid-feedback {
        font-size: 0.85rem;
    }
    
    .modal-content {
        border-radius: 20px;
    }
    
    .modal-header {
        border-radius: 20px 20px 0 0;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
        border: none;
    }
    
    /* Image preview styling */
    .image-preview-item {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
</style>

<script>
function setLand(id) {
    document.getElementById('land_id').value = id;
}

// Image preview functionality for product modal
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.querySelector('input[name="images"]');
    const previewContainer = document.getElementById('imagePreviewContainer');
    const previewDiv = document.getElementById('imagePreview');
    
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            previewDiv.innerHTML = '';
            
            if (this.files.length > 0) {
                previewContainer.classList.remove('d-none');
                
                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview-item';
                        img.title = file.name;
                        previewDiv.appendChild(img);
                    }
                    
                    reader.readAsDataURL(file);
                }
            } else {
                previewContainer.classList.add('d-none');
            }
        });
    }
    
    // Initialize form fields with proper styling
    const formControls = document.querySelectorAll('.form-control, .form-select');
    formControls.forEach(control => {
        if (control.value) {
            control.classList.add('is-valid');
        }
        
        control.addEventListener('input', function() {
            if (this.value) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
            }
        });
    });
});
</script>

{% endblock %}